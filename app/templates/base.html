<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Mayoristas Paraguay Admin{% endblock %}</title>
    
    <!-- UUID handling - Must be first -->
    <script>
        // Get or generate UUID from localStorage
        let deviceUUID = localStorage.getItem('deviceUUID');
        if (!deviceUUID) {
            deviceUUID = crypto.randomUUID();
            localStorage.setItem('deviceUUID', deviceUUID);
        }
        
        // Set UUID cookie if not present
        if (!document.cookie.includes('X-Device-UUID=')) {
            document.cookie = `X-Device-UUID=${deviceUUID}; path=/; max-age=31536000`; // 1 year
        }

        // Get the UUID for use in fetch and forms
        function getDeviceUUID() {
            return localStorage.getItem('deviceUUID');
        }

        // Check if device is authorized for a specific feature
        async function checkFeatureAuthorization(featureId) {
            try {
                const response = await fetch(`/api/features/${featureId}/check`, {
                    headers: {
                        'X-Device-UUID': getDeviceUUID()
                    }
                });
                return response.ok;
            } catch (error) {
                console.error('Error checking feature authorization:', error);
                return false;
            }
        }

        // Update menu visibility based on feature authorization
        async function updateMenuVisibility() {
            const menuItems = document.querySelectorAll('[data-feature-id]');
            for (const item of menuItems) {
                const featureId = item.getAttribute('data-feature-id');
                const isAuthorized = await checkFeatureAuthorization(featureId);
                if (!isAuthorized) {
                    item.remove();
                }
            }
        }

        // Override fetch to include UUID
        const originalFetch = window.fetch;
        window.fetch = function() {
            let [resource, config] = arguments;
            if (!config) {
                config = {};
            }
            if (!config.headers) {
                config.headers = {};
            }
            
            // Ensure we're working with a plain object for headers
            const headers = {};
            
            // Copy existing headers
            if (config.headers instanceof Headers) {
                for (const [key, value] of config.headers.entries()) {
                    headers[key] = value;
                }
            } else {
                Object.assign(headers, config.headers);
            }
            
            // Add our UUID header
            headers['X-Device-UUID'] = getDeviceUUID();
            
            // Replace the headers in the config
            config.headers = headers;
            
            return originalFetch(resource, config);
        };

        // Add UUID to forms and check authorization when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            const forms = document.querySelectorAll('form');
            forms.forEach(form => {
                let input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'X-Device-UUID';
                input.value = getDeviceUUID();
                form.appendChild(input);
            });

            // Update menu visibility
            updateMenuVisibility();
        });
    </script>
    
    <!-- Favicon - dynamically updated based on branding -->
    <link rel="icon" href="https://unificadesign.com.py/img/unifica/footerIcon.png" type="image/png" id="favicon">
    <!-- Dark mode script - must be before Tailwind CSS -->
    <script>
        // On page load or when changing themes, best to add inline in `head` to avoid FOUC
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
    <!-- Tailwind CSS with dark mode enabled -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {}
            }
        }
    </script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="h-full bg-gray-100 dark:bg-gray-900">
    <nav class="bg-white dark:bg-gray-800 shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16">
                <div class="flex justify-between w-full">
                    <div class="flex-shrink-0 flex items-center">
                        <a href="/admin" class="text-xl font-bold text-gray-800 dark:text-white">Mayoristas Paraguay</a>
                    </div>
                    <!-- Desktop Menu -->
                    <div class="hidden md:ml-6 md:flex md:space-x-8" id="desktop-menu">
                        <!-- Menu items will be loaded dynamically -->
                    </div>
                    <!-- Mobile menu button -->
                    <div class="-mr-2 flex items-center md:hidden">
                        <button id="mobile-menu-button" type="button" class="inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-pink-500 dark:hover:bg-gray-700" aria-controls="mobile-menu" aria-expanded="false">
                            <span class="sr-only">Open main menu</span>
                            <i data-lucide="menu" class="block h-6 w-6"></i>
                        </button>
                    </div>
                </div>
            </div>
            <!-- Mobile menu -->
            <div class="hidden md:hidden" id="mobile-menu">
                <div class="pt-2 pb-3 space-y-1" id="mobile-menu-items">
                    <!-- Mobile menu items will be loaded dynamically -->
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        {% block content %}{% endblock %}
    </main>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Mobile menu toggle
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');

        mobileMenuButton.addEventListener('click', () => {
            const expanded = mobileMenuButton.getAttribute('aria-expanded') === 'true';
            mobileMenuButton.setAttribute('aria-expanded', !expanded);
            mobileMenu.classList.toggle('hidden');
        });

        // Theme toggle
        const themeToggleBtn = document.getElementById('theme-toggle');
        const htmlElement = document.documentElement;

        // Check for saved theme preference, otherwise use system preference
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            htmlElement.classList.add('dark');
        } else {
            htmlElement.classList.remove('dark');
        }

        themeToggleBtn.addEventListener('click', () => {
            htmlElement.classList.toggle('dark');
            localStorage.theme = htmlElement.classList.contains('dark') ? 'dark' : 'light';
        });

        function showError(message) {
            Swal.fire({
                title: 'Error!',
                text: message,
                icon: 'error',
                confirmButtonText: 'OK'
            });
        }

        function showSuccess(message) {
            Swal.fire({
                title: 'Success!',
                text: message,
                icon: 'success',
                confirmButtonText: 'OK'
            });
        }
    </script>

    <!-- Footer with branding -->
    <footer class="bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 py-6 mt-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col md:flex-row items-center justify-between">
                <div class="flex items-center">
                    <img id="brandingLogo" src="https://unificadesign.com.py/img/unifica/footerIcon.png" alt="Logo" class="h-10 w-auto mr-3">
                    <div>
                        <p id="brandingCopyright" class="text-gray-600 dark:text-gray-400 text-sm">Â© 2025 Unifica Paraguay. Todos los derechos reservados.</p>
                        <p id="brandingContact" class="text-gray-500 dark:text-gray-400 text-sm mt-1"></p>
                    </div>
                </div>
                <div class="mt-4 md:mt-0">
                    <p class="text-gray-500 dark:text-gray-400 text-xs">
                        Mayoristas Paraguay - Platform version 1.0
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // Fetch branding information from API
        async function fetchBranding() {
            try {
                const response = await fetch('/api/branding');
                if (response.ok) {
                    const data = await response.json();
                    
                    // Update logo
                    const logoElement = document.getElementById('brandingLogo');
                    if (logoElement && data.logo) {
                        logoElement.src = data.logo;
                    }
                    
                    // Update favicon
                    const faviconElement = document.getElementById('favicon');
                    if (faviconElement && data.logo) {
                        faviconElement.href = data.logo;
                    }
                    
                    // Update copyright
                    const copyrightElement = document.getElementById('brandingCopyright');
                    if (copyrightElement && data.copyright) {
                        copyrightElement.textContent = data.copyright;
                    }
                    
                    // Update contact number
                    const contactElement = document.getElementById('brandingContact');
                    if (contactElement && data.contact_number) {
                        contactElement.textContent = data.contact_number;
                    }
                }
            } catch (error) {
                console.error('Failed to fetch branding:', error);
            }
        }

        // Call on page load
        fetchBranding();
    </script>

    <script>
        // Menu configuration
        const menuItems = [
            {
                id: 'dashboard',
                name: 'Dashboard',
                icon: 'layout-dashboard',
                href: '/admin'
            },
            {
                id: 'shop_management',
                name: 'Shops',
                icon: 'shopping-cart',
                href: '/admin/shops'
            },
            {
                id: 'category_management',
                name: 'Categories',
                icon: 'tag',
                href: '/admin/categories'
            },
            {
                id: 'zone_management',
                name: 'Zones',
                icon: 'map-pin',
                href: '/admin/zones'
            },
            {
                id: 'banner_management',
                name: 'Banners',
                icon: 'image',
                href: '/admin/banners'
            },
            {
                id: 'branding_management',
                name: 'Branding',
                icon: 'palette',
                href: '/admin/branding'
            },
            {
                id: 'device_management',
                name: 'Devices',
                icon: 'smartphone',
                href: '/admin/devices'
            }
        ];

        // Create menu item HTML
        function createDesktopMenuItem(item, isActive) {
            return `
                <a href="${item.href}" 
                   data-feature-id="${item.id}" 
                   class="inline-flex items-center px-1 pt-1 border-b-2 ${
                       isActive 
                       ? 'text-indigo-500 border-indigo-500' 
                       : 'text-gray-500 dark:text-gray-400 border-transparent hover:text-indigo-500 hover:border-indigo-500 dark:hover:text-indigo-400'
                   } transition-colors">
                    <i data-lucide="${item.icon}" class="w-5 h-5 mr-1"></i>
                    ${item.name}
                </a>
            `;
        }

        function createMobileMenuItem(item, isActive) {
            return `
                <a href="${item.href}" 
                   data-feature-id="${item.id}" 
                   class="block pl-3 pr-4 py-2 text-base font-medium rounded-md flex items-center ${
                       isActive 
                       ? 'text-indigo-500 bg-indigo-50 dark:bg-indigo-900/50' 
                       : 'text-gray-500 dark:text-gray-400 hover:text-indigo-500 hover:bg-gray-50 dark:hover:bg-gray-700'
                   }">
                    <i data-lucide="${item.icon}" class="w-5 h-5 mr-2"></i>
                    ${item.name}
                </a>
            `;
        }

        // Load menu items
        async function loadMenuItems() {
            const desktopMenu = document.getElementById('desktop-menu');
            const mobileMenuItems = document.getElementById('mobile-menu-items');
            const currentPath = window.location.pathname;
            
            let desktopHtml = '';
            let mobileHtml = '';

            // Check authorization for each menu item
            for (const item of menuItems) {
                const isAuthorized = await checkFeatureAuthorization(item.id);
                if (isAuthorized) {
                    const isActive = currentPath === item.href;
                    desktopHtml += createDesktopMenuItem(item, isActive);
                    mobileHtml += createMobileMenuItem(item, isActive);
                }
            }

            // Add theme toggle and logout buttons to desktop menu
            desktopHtml += `
                <button id="theme-toggle" type="button" class="inline-flex items-center px-1 pt-1 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 transition-colors">
                    <i data-lucide="sun" class="w-5 h-5 hidden dark:block"></i>
                    <i data-lucide="moon" class="w-5 h-5 block dark:hidden"></i>
                </button>
                <a href="/logout" class="inline-flex items-center px-1 pt-1 text-red-500 hover:text-red-700 dark:hover:text-red-400 transition-colors">
                    <i data-lucide="log-out" class="w-5 h-5 mr-1"></i>
                    Logout
                </a>
            `;

            // Add logout button to mobile menu
            mobileHtml += `
                <a href="/logout" class="block pl-3 pr-4 py-2 text-base font-medium text-red-500 hover:text-red-700 hover:bg-red-50 dark:hover:bg-red-900/50 rounded-md flex items-center">
                    <i data-lucide="log-out" class="w-5 h-5 mr-2"></i>
                    Logout
                </a>
            `;

            // Update the menus
            desktopMenu.innerHTML = desktopHtml;
            mobileMenuItems.innerHTML = mobileHtml;

            // Reinitialize Lucide icons for the new menu items
            lucide.createIcons();

            // Reattach theme toggle event listener
            const themeToggleBtn = document.getElementById('theme-toggle');
            if (themeToggleBtn) {
                themeToggleBtn.addEventListener('click', () => {
                    htmlElement.classList.toggle('dark');
                    localStorage.theme = htmlElement.classList.contains('dark') ? 'dark' : 'light';
                });
            }
        }

        // Load menu items when DOM is ready
        document.addEventListener('DOMContentLoaded', loadMenuItems);
    </script>

    {% block scripts %}{% endblock %}
</body>
</html> 